<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDX Hackerspace Chat</title>
  <link rel="stylesheet" href="styles.css" /> 

  <style>
    .chat-container { max-width: 800px; margin: 2rem auto; padding: 1rem; }
    .message-list {
      border: 1px solid #ccc; border-radius: 5px; padding: 1rem;
      height: 60vh; overflow-y: auto; background: #f9f9f9;
    }
    .message { margin: 0.5rem 0; padding: 0.5rem 0.75rem; border-radius: 4px; word-wrap: break-word; }
    .message.user { background: #e0f7fa; text-align: right; }
    .message.bot { background: #e8eaf6; text-align: left; }
    .message.bot .thinking-indicator { font-style: italic; color: #555; }
    .input-area { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .input-area input[type="text"] { flex: 1; padding: 0.5rem; font-size: 1rem; }
    .input-area button { padding: 0.5rem 1rem; font-size: 1rem; }
  </style>
</head>
<body>

  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="About.html">About</a></li>
      <li><a href="FAQ.html">FAQ</a></li>
      <li><a href="chat.html"><strong>Chat</strong></a></li>
    </ul>
  </nav>

  <div class="chat-container">
    <h2>Hackerspace Chat Bot</h2>
    <p>Ask our Hackerspace AI anything!</p>
    <div id="message-list" class="message-list"></div>
    <form id="chat-form" class="input-area">
      <input type="text" id="user-input" placeholder="Type your question..." autocomplete="off" required>
      <button type="submit">Send</button>
    </form>
  </div>

<script>
const form = document.getElementById('chat-form');
const userInput = document.getElementById('user-input');
const messageList = document.getElementById('message-list');

function appendMessage(text, sender, isThinking = false) {
  const msgDiv = document.createElement('div');
  msgDiv.classList.add('message', sender);
  if (sender === 'bot' && isThinking) {
    const thinkSpan = document.createElement('span');
    thinkSpan.classList.add('thinking-indicator');
    thinkSpan.textContent = 'Thinking';
    const dotsSpan = document.createElement('span');
    dotsSpan.textContent = '...';
    thinkSpan.appendChild(dotsSpan);
    msgDiv.appendChild(thinkSpan);
    let dotCount = 3;
    msgDiv._thinkingInterval = setInterval(() => {
      dotCount = (dotCount % 3) + 1;
      dotsSpan.textContent = '.'.repeat(dotCount);
    }, 500);
  } else {
    msgDiv.textContent = text;
  }
  messageList.appendChild(msgDiv);
  messageList.scrollTop = messageList.scrollHeight;
  return msgDiv;
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const question = userInput.value.trim();
  if (!question) return;

  appendMessage(question, 'user');
  userInput.value = '';
  
  const botMsgDiv = appendMessage('', 'bot', true);
  
  try {
    const response = await fetch('https://venice-backend-14aff752beac.herokuapp.com/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: question }),
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let partialText = '';
    let thinking = true;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value, { stream: true });

      if (thinking) {
        const endThinkIdx = chunk.indexOf('</think>');
        if (endThinkIdx !== -1) {
          thinking = false;
          if (botMsgDiv._thinkingInterval) {
            clearInterval(botMsgDiv._thinkingInterval);
            botMsgDiv._thinkingInterval = null;
          }
          botMsgDiv.textContent = '';
          partialText += chunk.substring(endThinkIdx + 8);
          botMsgDiv.textContent = partialText;
        }
      } else {
        partialText += chunk;
        botMsgDiv.textContent = partialText;
      }
      messageList.scrollTop = messageList.scrollHeight;
    }
  } catch (err) {
    console.error('Error:', err);
    botMsgDiv.textContent = "[Error receiving response]";
    if (botMsgDiv._thinkingInterval) clearInterval(botMsgDiv._thinkingInterval);
  }
});
</script>
</body>
</html>
