---
# this is an empty front matter
---

<!DOCTYPE html>
<html>
  {% include head.html %}
  <head>
    <!-- Include Prism.js CSS for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
    <!-- Additional inline styles for code blocks, thoughts area, etc. -->
    <style>
      /* Call-to-Action and Info Icon Styles */
      .info-icon {
        display: inline-block;
        color: #3498db;
        cursor: help;
        margin-left: 5px;
        font-style: normal;
      }
      .info-icon:hover::after {
        content: attr(title);
        position: absolute;
        background: #fff;
        padding: 10px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        max-width: 300px;
        font-size: 14px;
        color: #333;
        z-index: 1000;
        margin-top: 20px;
        margin-left: -150px;
      }

      /* Code Block Styling */
      .code-block {
        position: relative;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 1rem;
        margin: 1em 0;
        overflow-x: auto;
      }
      .code-block code {
        display: block;
        font-family: Consolas, monospace;
        font-size: 0.95em;
        line-height: 1.4;
      }
      .copy-button {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #e0e0e0;
        border: none;
        padding: 4px 8px;
        font-size: 0.9em;
        font-family: sans-serif;
        cursor: pointer;
        border-radius: 3px;
        color: #333;
        opacity: 0.8;
        transition: opacity 0.2s, background 0.2s;
      }
      .copy-button:hover, .copy-button:focus {
        opacity: 1.0;
        background: #d5d5d5;
      }
      .copy-button:active {
        background: #ccc;
      }

      /* Thoughts Container Styling */
      .thoughts-container {
        margin-bottom: 1rem;
      }
      /* Flex container for the thoughts header */
      .thoughts-header {
        display: flex;
        align-items: center;
        font-style: italic;
        font-size: 1em;
        cursor: pointer;
      }
      .thoughts-content {
        display: none;
        margin-top: 0.5rem;
        padding: 0.5rem;
        border: 1px solid #ddd;
        background: #f4f4f4;
        white-space: pre-wrap; /* Preserves newlines */
      }

      /* Brain emoji animation */
      @keyframes pulsate {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
      }
      .pulsate {
        animation: pulsate 1s ease-in-out infinite;
      }
      .brain-emoji {
        font-size: 1.2em;
        margin-left: 16px; /* Extra space to separate from the text */
      }

      /* User Input Textarea Styling */
      #user-input {
        max-height: 60vh;
        overflow-y: hidden;
      }

      /* Chat Message Container */
      #message-list {
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 1rem;
        height: 60vh;
        overflow-y: auto;
        background: #f9f9f9;
      }
    </style>
  </head>
  <body>
    {% include header.html %}
    {% include covid-19-banner.html %}

    <!-- Top Call-to-Action Section -->
    <div class="full no-padding" style="background: #fff;">
      <div class="mod modCallToAction">
        <div class="row">
          <div class="small-12 columns" style="text-align: center;">
            <p>Try our new Hackerspace chatbot! <span class="info-icon" title="This is an experimental AI assistant. Responses may not be accurate or complete. Use this tool for general guidance only, and verify any critical information through official channels.">â“˜</span></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Chat Container -->
    <div id="main" role="main">
      <div class="full" style="background: #fff; padding: 2rem 0;">
        <div class="row">
          <div class="medium-8 medium-offset-2 columns">
            <!-- Chat Messages Display -->
            <div id="message-list">
              <!-- Chat messages will be appended here -->
            </div>
            <!-- Chat Input Form using a multi-line textarea -->
            <form id="chat-form" class="input-area" style="margin-top: 1rem; display: flex; gap: 0.5rem;">
              <textarea id="user-input" placeholder="Type your question (Shift+Enter for newline, Enter to send)..." autocomplete="off" required style="flex: 1; padding: 0.5rem; font-size: 1rem; resize: vertical; height: 3rem;"></textarea>
              <button type="submit" style="padding: 0.5rem 1rem; font-size: 1rem;">Send</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Call-to-Action Section -->
    <div class="full no-padding" style="background: #fff; margin-top: 2rem;">
      <div class="mod modCallToAction">
        <div class="row">
          <div class="small-12 columns" style="text-align: center;">
            <p>chat not working? <span class="info-icon" title="This is an experimental AI assistant. Responses may not be accurate or complete. Use this tool for general guidance only, and verify any critical information through official channels.">â“˜</span></p>
            <a class="button" href="https://venice.ai/c/jack-hacksman" target="_blank" rel="noopener noreferrer">alternative chat</a>
          </div>
        </div>
      </div>
    </div>

    {% include footer.html %}

    <!-- Include marked library for markdown parsing and Prism.js for syntax highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

    <!-- Existing JS files -->
    <script src="javascripts/jquery.countTo.js" type="text/javascript"></script>
    <script src="javascripts/jquery.appear.js" type="text/javascript"></script>
    <script src="javascripts/jquery.validate.js" type="text/javascript"></script>
    <script src="javascripts/jquery.sequence-min.js" type="text/javascript"></script>
    <script src="javascripts/jquery.easing.1.3.js" type="text/javascript"></script>
    <script src="javascripts/app.js" type="text/javascript"></script>

    <!-- Full inline JS wrapped in DOMContentLoaded -->
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const messageList = document.getElementById('message-list');

        // Global conversation history array.
        // Start with the system prompt.
        const SYSTEM_PROMPT = "You are the PDX Hackerspace AI assistant. The user may ask about our organization. Use the provided context to answer helpfully.\n\nContext:\nPDX Hackerspace is a non-profit makerspace in Portland, OR, located at 7608 N Interstate Ave. It offers 24/7 member access and provides various tools and resources for makers. Additional details will be provided soon.\n\nEnd of context.";
        let conversationHistory = [{ role: "system", content: SYSTEM_PROMPT }];

        // Auto-resize the textarea.
        userInput.addEventListener('input', function() {
          this.style.height = 'auto';
          const computedStyle = window.getComputedStyle(this);
          const maxHeight = parseInt(computedStyle.getPropertyValue('max-height'), 10);
          let newHeight = this.scrollHeight;
          if (newHeight > maxHeight) {
            newHeight = maxHeight;
            this.style.overflowY = 'auto';
          } else {
            this.style.overflowY = 'hidden';
          }
          this.style.height = newHeight + 'px';
        });

        // Key binding: Plain Enter sends; Shift+Enter adds newline.
        userInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            form.dispatchEvent(new Event('submit', {cancelable: true}));
          }
        });

        // Render markdown using marked.
        function renderMarkdown(text) {
          return marked.parse(text);
        }

        // Escape HTML for raw text display.
        function escapeHTML(str) {
          return str.replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
        }

        // Add copy buttons to any code blocks.
        function addCopyButtons(container) {
          const codeBlocks = container.querySelectorAll("div.code-block");
          codeBlocks.forEach((block) => {
            if (block.querySelector(".copy-button")) return;
            const copyButton = document.createElement("button");
            copyButton.classList.add("copy-button");
            copyButton.textContent = "Copy";
            copyButton.setAttribute("aria-label", "Copy code");
            copyButton.addEventListener("click", () => {
              const codeElement = block.querySelector("pre code");
              if (!codeElement) return;
              const codeText = codeElement.textContent;
              navigator.clipboard.writeText(codeText)
                .then(() => {
                  copyButton.textContent = "Copied!";
                  setTimeout(() => { copyButton.textContent = "Copy"; }, 2000);
                })
                .catch(() => {
                  copyButton.textContent = "Error";
                });
            });
            block.style.position = "relative";
            block.appendChild(copyButton);
          });
        }

        // Auto-scroll function.
        let autoScrollTimer;
        function maybeAutoScroll() {
          clearTimeout(autoScrollTimer);
          autoScrollTimer = setTimeout(() => {
            const threshold = 150;
            const distanceFromBottom = messageList.scrollHeight - messageList.scrollTop - messageList.clientHeight;
            if (distanceFromBottom <= threshold) {
              messageList.scrollTop = messageList.scrollHeight;
            }
          }, 50);
        }

        // Append a new message to the UI.
        // For bot messages in thinking mode, set up the header with a toggle icon, label, and a brain emoji.
        function appendMessage(text, sender, isThinking = false) {
          const msgDiv = document.createElement('div');
          msgDiv.classList.add('message', sender);
          msgDiv.style.margin = "0.5rem 0";
          msgDiv.style.padding = "0.5rem 0.75rem";
          msgDiv.style.borderRadius = "4px";
          msgDiv.style.wordWrap = "break-word";

          if (sender === 'user') {
            msgDiv.style.background = "#e0f7fa";
            msgDiv.style.textAlign = "right";
            msgDiv.innerHTML = renderMarkdown(text);
          } else if (sender === 'bot' && isThinking) {
            const container = document.createElement('div');
            container.classList.add('bot-message-container');

            const thoughtsContainer = document.createElement('div');
            thoughtsContainer.classList.add('thoughts-container');

            const thoughtsHeader = document.createElement('div');
            thoughtsHeader.classList.add('thoughts-header');

            const toggleIcon = document.createElement('span');
            toggleIcon.classList.add('toggle-icon');
            toggleIcon.textContent = '[+] ';
            toggleIcon.style.marginRight = '8px';

            const headerLabel = document.createElement('span');
            headerLabel.textContent = 'Thinking';
            headerLabel.id = 'thoughts-label';
            headerLabel.style.marginRight = '8px';

            const brainEmoji = document.createElement('span');
            brainEmoji.classList.add('brain-emoji', 'pulsate');
            brainEmoji.textContent = 'ðŸ§ ';

            const headerContainer = document.createElement('div');
            headerContainer.style.display = 'flex';
            headerContainer.style.alignItems = 'center';
            headerContainer.appendChild(toggleIcon);
            headerContainer.appendChild(headerLabel);
            headerContainer.appendChild(brainEmoji);

            thoughtsHeader.appendChild(headerContainer);
            thoughtsContainer.appendChild(thoughtsHeader);

            const thoughtsContent = document.createElement('div');
            thoughtsContent.classList.add('thoughts-content');
            thoughtsContent.style.display = 'none';
            thoughtsContent.style.marginTop = "0.5rem";
            thoughtsContent.style.padding = "0.5rem";
            thoughtsContent.style.border = "1px solid #ddd";
            thoughtsContent.style.background = "#f4f4f4";
            thoughtsContainer.appendChild(thoughtsContent);

            container.appendChild(thoughtsContainer);

            const mainContentDiv = document.createElement('div');
            mainContentDiv.classList.add('main-content');
            container.appendChild(mainContentDiv);

            msgDiv.appendChild(container);
            messageList.appendChild(msgDiv);
            maybeAutoScroll();

            // Save references for updating streaming responses.
            msgDiv._mainContentDiv = mainContentDiv;
            msgDiv._thoughtsContent = thoughtsContent;
            msgDiv._thoughtsLabel = headerLabel;
            msgDiv._brainEmoji = brainEmoji;
            msgDiv._toggleIcon = toggleIcon;

            thoughtsHeader.addEventListener('click', () => {
              if (thoughtsContent.style.display === 'none') {
                thoughtsContent.style.display = 'block';
                toggleIcon.textContent = '[-] ';
              } else {
                thoughtsContent.style.display = 'none';
                toggleIcon.textContent = '[+] ';
              }
            });
            return msgDiv;
          } else {
            msgDiv.innerHTML = renderMarkdown(text);
          }
          messageList.appendChild(msgDiv);
          maybeAutoScroll();
          return msgDiv;
        }

        // On form submission, update conversation history and send the full history.
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const question = userInput.value.trim();
          if (!question) return;
          // Append user message to UI and add to conversation history.
          appendMessage(question, 'user');
          conversationHistory.push({ role: 'user', content: question });
          userInput.value = '';
          userInput.style.height = "3rem";

          // Append an empty bot message in thinking mode.
          const botMsgDiv = appendMessage('', 'bot', true);

          let thinkingBlock = "";
          let mainContent = "";
          let inThinkBlock = false;

          try {
            // Send full conversation history to the backend.
            const response = await fetch("https://venice-backend-14aff752beac.herokuapp.com/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ messages: conversationHistory })
            });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";

            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              buffer += decoder.decode(value, { stream: true });
              let lines = buffer.split("\n");
              buffer = lines.pop();
              for (let line of lines) {
                if (!line.startsWith("data: ")) continue;
                const jsonStr = line.slice(6).trim();
                if (jsonStr === "[DONE]") continue;
                try {
                  const data = JSON.parse(jsonStr);
                  let token = (data.choices && data.choices[0] && data.choices[0].delta && data.choices[0].delta.content) || "";
                  if (!token) continue;
                  if (token.indexOf("<think>") !== -1 && !inThinkBlock) {
                    inThinkBlock = true;
                  }
                  if (inThinkBlock) {
                    thinkingBlock += token;
                    if (botMsgDiv._thoughtsContent) {
                      botMsgDiv._thoughtsContent.innerHTML = escapeHTML(thinkingBlock);
                    }
                    if (token.indexOf("</think>") !== -1) {
                      inThinkBlock = false;
                      if (botMsgDiv._thoughtsLabel) {
                        botMsgDiv._thoughtsLabel.textContent = "Thoughts";
                      }
                      if (botMsgDiv._brainEmoji) {
                        botMsgDiv._brainEmoji.classList.remove('pulsate');
                      }
                    }
                  } else {
                    mainContent += token;
                    if (botMsgDiv._mainContentDiv) {
                      botMsgDiv._mainContentDiv.innerHTML = renderMarkdown(mainContent);
                      botMsgDiv._mainContentDiv.querySelectorAll("pre").forEach(pre => {
                        if (!pre.parentElement.classList.contains("code-block")) {
                          const wrapper = document.createElement("div");
                          wrapper.classList.add("code-block");
                          pre.parentElement.insertBefore(wrapper, pre);
                          wrapper.appendChild(pre);
                        }
                      });
                      addCopyButtons(botMsgDiv._mainContentDiv);
                    }
                  }
                } catch (err) {
                  console.error("JSON parse error:", err, "in line:", line);
                }
              }
              maybeAutoScroll();
            }
            // Once streaming is complete, add the assistant message to conversation history.
            conversationHistory.push({ role: 'assistant', content: mainContent });
          } catch (err) {
            console.error("Error receiving response:", err);
            if (botMsgDiv._toggleIcon) {
              botMsgDiv._toggleIcon.remove();
            }
            botMsgDiv.textContent = "[Error receiving response]";
          }
        });
      });
    </script>
  </body>
</html>
